# å£¹ç‚¹çµ (YDL) æ•°æ®é‡‡é›†å·¥å…·

å®Œæ•´é‡‡é›† `https://m.ydl.com/ask` çš„å¸–å­ã€è¯„è®ºä¸å…ƒæ•°æ®ï¼Œæ”¯æŒé¦–æŠ“ä¸å¢é‡æ›´æ–°ã€‚

## åŠŸèƒ½ç‰¹æ€§

âœ… **éµå®ˆè§„åˆ™**
- éµå¾ª robots.txt è§„èŒƒ
- é»˜è®¤é™é€Ÿ 0.5 QPSï¼Œå¯é…ç½®
- æŒ‡æ•°é€€é¿ä¸éšæœºæŠ–åŠ¨
- ç¤¼è²ŒæŠ“å–ï¼Œä¿æŠ¤ç›®æ ‡ç«™ç‚¹

âœ… **æ•°æ®å®Œæ•´æ€§**
- é‡‡é›†æ‰€æœ‰å¿…éœ€å­—æ®µï¼ˆç”¨æˆ·ã€å†…å®¹ã€æ—¶é—´ã€äº’åŠ¨æ•°æ®ç­‰ï¼‰
- ä¿ç•™åŸå§‹å“åº”æ•°æ®ç”¨äºå›æº¯
- è‡ªåŠ¨å»é‡ä¸å¹‚ç­‰æ€§ä¿è¯
- SHA1 å†…å®¹æŒ‡çº¹é˜²é‡å¤

âœ… **ç¨³å¥æ€§**
- æµ‹è¯•å…ˆè¡Œå¼€å‘ï¼ˆTDDï¼‰
- è‡ªåŠ¨é‡è¯•ä¸é”™è¯¯å¤„ç†
- æ˜¾å¼ç­‰å¾…ä¸ç¨³å¥é€‰æ‹©å™¨
- æ–­ç‚¹ç»­ä¼ ä¸å¢é‡æ›´æ–°

âœ… **ç›‘æ§ä¸å¯è§‚æµ‹æ€§**
- å®æ—¶ç»Ÿè®¡ä¸æ€§èƒ½æŒ‡æ ‡
- å¥åº·æ£€æŸ¥ä¸å‘Šè­¦
- è¯¦ç»†æ—¥å¿—è®°å½•
- æ”¯æŒ Slack/Discord å‘Šè­¦

## æ¶æ„è®¾è®¡

```
PG533/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ settings.py           # é…ç½®ç®¡ç†
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ models.py             # æ•°æ®æ¨¡å‹ (Post, Comment)
â”‚   â”œâ”€â”€ scraper.py            # æ ¸å¿ƒçˆ¬è™«é€»è¾‘
â”‚   â”œâ”€â”€ rate_limiter.py       # é™é€Ÿå™¨
â”‚   â”œâ”€â”€ storage.py            # å­˜å‚¨ä¸å»é‡
â”‚   â””â”€â”€ monitor.py            # ç›‘æ§ä¸å‘Šè­¦
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py           # pytest é…ç½®
â”‚   â”œâ”€â”€ test_models.py        # æ¨¡å‹æµ‹è¯•
â”‚   â”œâ”€â”€ test_rate_limiter.py  # é™é€Ÿå™¨æµ‹è¯•
â”‚   â””â”€â”€ test_scraper.py       # çˆ¬è™«æµ‹è¯•
â”œâ”€â”€ data/                     # æ•°æ®å­˜å‚¨ç›®å½•
â”‚   â”œâ”€â”€ posts/                # è§£æåçš„å¸–å­
â”‚   â”œâ”€â”€ raw/                  # åŸå§‹ API å“åº”
â”‚   â”œâ”€â”€ checkpoint.json       # å¢é‡æ›´æ–°æ£€æŸ¥ç‚¹
â”‚   â”œâ”€â”€ seen_ids.txt          # å·²æŠ“å– ID åˆ—è¡¨
â”‚   â””â”€â”€ dataset.jsonl         # å¯¼å‡ºæ•°æ®é›†
â”œâ”€â”€ logs/                     # æ—¥å¿—ç›®å½•
â”‚   â””â”€â”€ metrics.jsonl         # æŒ‡æ ‡å†å²
â”œâ”€â”€ main.py                   # CLI å…¥å£
â”œâ”€â”€ requirements.txt          # Python ä¾èµ–
â””â”€â”€ README.md                 # æœ¬æ–‡æ¡£
```

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ– venv\Scripts\activate  # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å®‰è£… Playwright æµè§ˆå™¨
playwright install chromium
```

### 2. åŸºæœ¬ä½¿ç”¨

```bash
# å®Œæ•´æŠ“å–
python main.py --mode full

# å¢é‡æ›´æ–°ï¼ˆä»…æŠ“å–æ–°å†…å®¹ï¼‰
python main.py --mode incremental

# æ— å¤´æ¨¡å¼ï¼ˆåå°è¿è¡Œï¼‰
python main.py --headless

# è‡ªå®šä¹‰é™é€Ÿ
python main.py --qps 0.3 --burst 1
```

### 3. é«˜çº§é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# ç›®æ ‡ç«™ç‚¹
TARGET_ROOT=https://m.ydl.com/ask
BASE_URL=https://m.ydl.com

# é™é€Ÿé…ç½®
QPS_LIMIT=0.5
BURST=2
RETRY=3
BACKOFF_BASE=1.0
BACKOFF_MAX=60.0

# æµè§ˆå™¨é…ç½®
HEADLESS=true
VIEWPORT_WIDTH=375
VIEWPORT_HEIGHT=812

# å­˜å‚¨
DATA_DIR=data
LOGS_DIR=logs

# å‘Šè­¦ï¼ˆå¯é€‰ï¼‰
ALERT_SINK=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

## æ•°æ®å­—å…¸

### ä¸»å¸–å­—æ®µ

| å­—æ®µå | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|--------|------|------|------|
| `post_id` | int | âœ… | å¸–å­å”¯ä¸€ID |
| `username` | str | âœ… | ç”¨æˆ·å |
| `avatar_url` | str | â­• | ç”¨æˆ·å¤´åƒé“¾æ¥ |
| `publish_time` | str | âœ… | å‘è¡¨æ—¶é—´ |
| `content` | str | âœ… | å¸–å­å†…å®¹ |
| `view_count` | int | âœ… | é˜…è¯»æ•° |
| `warm_count` | int | âœ… | æ¸©æš–æ•° |
| `visit_count` | int | âœ… | çœ‹è§æ•° |
| `topic_title` | str | â­• | å¿ƒçƒåç§° |
| `post_url` | str | âœ… | åŸå¸–é“¾æ¥ |
| `uid` | int | â­• | ç”¨æˆ·ID |
| `gender` | int | â­• | æ€§åˆ« |
| `is_anonymous` | bool | âœ… | æ˜¯å¦åŒ¿å |
| `reply_counter` | int | âœ… | è¯„è®ºæ€»æ•° |
| `comments` | list | âœ… | è¯„è®ºåˆ—è¡¨ |

### è¯„è®ºå­—æ®µ

| å­—æ®µå | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|--------|------|------|------|
| `comment_id` | int | â­• | è¯„è®ºID |
| `username` | str | âœ… | è¯„è®ºç”¨æˆ·æ˜µç§° |
| `avatar_url` | str | â­• | è¯„è®ºå¤´åƒé“¾æ¥ |
| `user_type` | int | â­• | èº«ä»½æ ‡ç­¾ (1=å’¨è¯¢å¸ˆ) |
| `comment_time` | str | âœ… | è¯„è®ºæ—¶é—´ |
| `comment_content` | str | âœ… | è¯„è®ºå†…å®¹ |
| `like_count` | int | âœ… | ç‚¹èµæ•° |
| `reply_to_username` | str | â­• | è¢«å›å¤çš„ç”¨æˆ·å |
| `reply_type` | str | âœ… | "post" æˆ– "comment" |

## æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_models.py

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
pytest -v

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=src --cov-report=html
```

## ç›‘æ§ä¸å‘Šè­¦

### ç»Ÿè®¡æŒ‡æ ‡

- **æ€»å¸–å­æ•°**: æœ¬æ¬¡æŠ“å–çš„å¸–å­æ€»æ•°
- **æ€»è¯„è®ºæ•°**: æ‰€æœ‰å¸–å­çš„è¯„è®ºæ€»æ•°
- **æˆåŠŸç‡**: `æˆåŠŸæ•° / (æˆåŠŸæ•° + é”™è¯¯æ•°) * 100%`
- **HTTP çŠ¶æ€ç åˆ†å¸ƒ**: 200, 404, 403, 429 ç­‰
- **æ€§èƒ½æŒ‡æ ‡**: å¸–å­/åˆ†é’Ÿ

### å¥åº·æ£€æŸ¥

è‡ªåŠ¨æ£€æµ‹ä»¥ä¸‹æƒ…å†µå¹¶å‘é€å‘Šè­¦ï¼š

- âŒ **æˆåŠŸç‡ < 50%**: Critical
- âš ï¸ **æˆåŠŸç‡ < 80%**: Warning  
- âš ï¸ **ç©ºé¡µæ•° > 5**: Warning
- âŒ **é‡åˆ° 403/429**: Criticalï¼ˆé™æµ/å°ç¦ï¼‰

### é…ç½®å‘Šè­¦

```bash
# Slack Webhook
python main.py --alert-sink https://hooks.slack.com/services/YOUR/WEBHOOK/URL

# æˆ–åœ¨ .env ä¸­é…ç½®
ALERT_SINK=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

## å¢é‡æ›´æ–°æœºåˆ¶

### å·¥ä½œåŸç†

1. é¦–æ¬¡æŠ“å–åï¼Œä¿å­˜æ£€æŸ¥ç‚¹ (`data/checkpoint.json`)
2. è®°å½• `last_post_id` å’Œ `last_post_time`
3. å¢é‡æ¨¡å¼ä¸‹ï¼ŒåªæŠ“å– ID > last_post_id çš„æ–°å¸–å­
4. è‡ªåŠ¨è·³è¿‡å·²è§è¿‡çš„å†…å®¹ï¼ˆåŸºäº SHA1 æŒ‡çº¹ï¼‰

### æ£€æŸ¥ç‚¹æ–‡ä»¶ç¤ºä¾‹

```json
{
  "last_post_id": 970141,
  "last_post_time": "ä»Šå¤© 14:51",
  "last_run_time": "2025-11-03T15:30:00",
  "total_posts_scraped": 1523,
  "cursor": null
}
```

## æ•°æ®å¯¼å‡º

### è‡ªåŠ¨å¯¼å‡º

æŠ“å–å®Œæˆåè‡ªåŠ¨ç”Ÿæˆ `data/dataset.jsonl`ï¼š

```jsonl
{"post_id": 970141, "username": "...", "content": "...", ...}
{"post_id": 970140, "username": "...", "content": "...", ...}
```

### æ‰‹åŠ¨å¯¼å‡º

```bash
# å¯¼å‡ºç°æœ‰æ•°æ®
python main.py --export-only

# ä¸å¯¼å‡ºï¼ˆä»…æŠ“å–ï¼‰
python main.py --no-export
```

## é™é€Ÿä¸ç¤¼è²ŒæŠ“å–

### é»˜è®¤ç­–ç•¥

- **QPS**: 0.5ï¼ˆæ¯2ç§’1ä¸ªè¯·æ±‚ï¼‰
- **çªå‘**: 2ï¼ˆæœ€å¤š2ä¸ªå¹¶å‘ï¼‰
- **é‡è¯•**: 3æ¬¡
- **é€€é¿**: æŒ‡æ•°é€€é¿ 1-60ç§’
- **æŠ–åŠ¨**: 10-30% éšæœºæŠ–åŠ¨

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

1. **ä¿æŠ¤ç›®æ ‡ç«™ç‚¹**: é¿å…å¯¹æœåŠ¡å™¨é€ æˆå‹åŠ›
2. **é¿å…å°ç¦**: é™ä½è¢«è¯†åˆ«ä¸ºæœºå™¨äººçš„é£é™©
3. **éµå®ˆè§„åˆ™**: ç¬¦åˆ robots.txt ç²¾ç¥
4. **å¯æŒç»­**: å…è®¸é•¿æœŸç¨³å®šé‡‡é›†

### è‡ªå®šä¹‰é™é€Ÿ

```bash
# æ›´ä¿å®ˆï¼ˆæ¯4ç§’1ä¸ªè¯·æ±‚ï¼‰
python main.py --qps 0.25 --burst 1

# æ›´æ¿€è¿›ï¼ˆæ¯ç§’1ä¸ªè¯·æ±‚ï¼Œé£é™©è¾ƒé«˜ï¼‰
python main.py --qps 1.0 --burst 3
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. æç¤º "Access restricted"**

- **åŸå› **: é‡åˆ° 403/429 çŠ¶æ€ç 
- **è§£å†³**: 
  - é™ä½ QPSï¼š`--qps 0.2`
  - å¢åŠ é€€é¿æ—¶é—´
  - æ£€æŸ¥ IP æ˜¯å¦è¢«å°ç¦
  - è€ƒè™‘ä½¿ç”¨ä»£ç†æ± 

**2. å¤§é‡ç©ºé¡µæˆ–æ— æ•°æ®**

- **åŸå› **: é¡µé¢ç»“æ„å˜æ›´æˆ–åçˆ¬æªæ–½
- **è§£å†³**:
  - æ£€æŸ¥ `data/raw/` ä¸­çš„åŸå§‹å“åº”
  - æ›´æ–°é€‰æ‹©å™¨æˆ–è§£æé€»è¾‘
  - æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦æƒ…

**3. Playwright å®‰è£…å¤±è´¥**

```bash
# æ‰‹åŠ¨å®‰è£…æµè§ˆå™¨
playwright install chromium

# æˆ–ä½¿ç”¨ç³»ç»Ÿæµè§ˆå™¨
playwright install-deps
```

**4. æµ‹è¯•å¤±è´¥**

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
pytest -v --tb=short

# å•ç‹¬è¿è¡Œå¤±è´¥çš„æµ‹è¯•
pytest tests/test_models.py::test_post_from_api_response -v
```

## Robots.txt åˆè§„æ€§

```
âœ… å…è®¸è®¿é—® /ask (æœªè¢« Disallow)
âŒ ç¦æ­¢è®¿é—®:
   - /*?* (å¸¦æŸ¥è¯¢å‚æ•°çš„URL)
   - /reg/, /login* (æ³¨å†Œ/ç™»å½•é¡µ)
   - /ot/, /uc* (å…¶ä»–é™åˆ¶åŒºåŸŸ)
```

**æœ¬å·¥å…·ä»…è®¿é—®å…¬å¼€çš„ `/ask` åˆ—è¡¨ä¸è¯¦æƒ…é¡µï¼Œå®Œå…¨åˆè§„ã€‚**

## æ€§èƒ½åŸºå‡†

åŸºäºé»˜è®¤é…ç½® (QPS=0.5, BURST=2):

- **10ä¸ªå¸–å­**: ~20ç§’
- **100ä¸ªå¸–å­**: ~200ç§’ (~3.3åˆ†é’Ÿ)
- **1000ä¸ªå¸–å­**: ~33åˆ†é’Ÿ

æé«˜ QPS å¯åŠ é€Ÿï¼Œä½†å¢åŠ å°ç¦é£é™©ã€‚

## å®‰å…¨ä¸éšç§

- âœ… ä»…é‡‡é›†å…¬å¼€å¯è§æ•°æ®
- âœ… ä¿ç•™æ¥æºURLä¸æ—¶é—´æˆ³
- âœ… ä¸é‡‡é›†éœ€è¦ç™»å½•çš„å†…å®¹
- âœ… ä¸é‡‡é›†ä¸ªäººéšç§ä¿¡æ¯ï¼ˆå¦‚æ‰‹æœºå·ï¼‰
- âš ï¸ ä½¿ç”¨æ•°æ®è¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

### å¼€å‘æµç¨‹

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ï¼š`git checkout -b feature/amazing-feature`
3. ç¼–å†™æµ‹è¯•ï¼š`tests/test_your_feature.py`
4. å®ç°åŠŸèƒ½ï¼šç¡®ä¿æµ‹è¯•é€šè¿‡
5. æäº¤ä»£ç ï¼š`git commit -m 'Add amazing feature'`
6. æ¨é€åˆ†æ”¯ï¼š`git push origin feature/amazing-feature`
7. æäº¤ PR

### ä»£ç è§„èŒƒ

- éµå¾ª PEP 8
- ä½¿ç”¨ç±»å‹æ³¨è§£
- ç¼–å†™æ–‡æ¡£å­—ç¬¦ä¸²
- æµ‹è¯•è¦†ç›–ç‡ > 80%

## è®¸å¯è¯

MIT License

## è‡´è°¢

- [Playwright](https://playwright.dev/) - æµè§ˆå™¨è‡ªåŠ¨åŒ–
- [Pydantic](https://pydantic.dev/) - æ•°æ®éªŒè¯
- [Structlog](https://www.structlog.org/) - ç»“æ„åŒ–æ—¥å¿—

## æŠ€æœ¯æ”¯æŒ

- ğŸ“§ Email: [æäº¤ Issue](https://github.com/your-repo/issues)
- ğŸ“š æ–‡æ¡£: æœ¬ README
- ğŸ› Bug æŠ¥å‘Š: [GitHub Issues](https://github.com/your-repo/issues)

---

**è­¦å‘Š**: ä½¿ç”¨æœ¬å·¥å…·è¯·éµå®ˆç›®æ ‡ç½‘ç«™çš„æœåŠ¡æ¡æ¬¾å’Œå½“åœ°æ³•å¾‹æ³•è§„ã€‚ä½œè€…ä¸å¯¹æ»¥ç”¨æœ¬å·¥å…·å¯¼è‡´çš„ä»»ä½•åæœè´Ÿè´£ã€‚

